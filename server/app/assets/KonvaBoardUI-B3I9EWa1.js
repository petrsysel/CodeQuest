var j=Object.defineProperty;var D=(m,e,t)=>e in m?j(m,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):m[e]=t;var c=(m,e,t)=>(D(m,typeof e!="symbol"?e+"":e,t),t);import{b as O,B as v}from"./blockly-O3kjd3d3.js";import{B as x}from"./NotificationUI-CzwHS9Nb.js";import{K as d}from"./konva-CKjuncwV.js";class f{constructor(){c(this,"_listeners");this._listeners=[]}emit(e,t){this._listeners.forEach(s=>{s.event==e&&s.callback(t)})}on(e,t){this._listeners.push({event:e,callback:t})}}class y{static getName(e){let t=this.names.get(e);return t||e}}c(y,"names",new Map([["nazev_typu","Jméno bloku"],["go_forward","Jdi vpřed"],["jump","Skoč"],["turn","Otoč se"],["set_direction","Nastav směr"],["jump_to","Skoč na"],["direction_pick","Výběr směru"],["position_x","Pozice x"],["position_y","Pozice y"],["direction","Směr"],["say","Řekni"],["change_costume","Změň kostým"],["change_background","Změň pozadí"],["show","Ukaž se"],["hide","Skryj se"],["set_layer","Nastav vrstvu"],["controls_repeat_ext","Opakuj x krát"],["controls_whileUntil","Opakuj dokud"],["controls_flow_statements","Přeruš cyklus"],["controls_if","Podmínka když"],["logic_compare","Logické porovnání"],["logic_operation","Logické operátory"],["logic_negate","Negace"],["logic_boolean","Pravdivostní hodnoty"],["logic_null","Null"],["logic_ternary","Ternární operátor"],["math_number","Číslo"],["math_arithmetic","Aritmetické operátory"],["math_single","Sqrt, abs, atd."],["math_trig","Goniometrické funkce"],["math_constant","Konstanty"],["math_number_property","Vlastnosti čísla"],["math_round","Zaokrouhlování"],["math_on_list","Operace se seznamy"],["math_modulo","Zbytek po dělení"],["math_constrain","Omezení rozsahu"],["math_random_int","Náhodné celé číslo"],["math_random_float","Náhodné desetinné číslo"],["text","Text"],["text_join","Spoj"],["text_length","Délka textu"],["text_isEmpty","Test prázdného textu"],["text_changeCase","Změna na velká/malá písměna"],["text_trim","Odstranění mezer z konců textu"],["on_start","Po startu"],["send_message","Vyšli zprávu"],["on_message_recieve","Po přijetí zprávy"],["win","Výtězství"],["game_over","Prohra"],["rule_check","Kontrola pravidel"],["wait","Čekej"],["distance_to","Vzdálenost k"],["is_touch","Dotýkáš se..."],["in_front_of_me","Je před tebou..."],["lists_create_with","Vytvoř seznam"],["lists_repeat","Vytvoř seznam plný..."],["lists_length","Délka seznamu"],["lists_isEmpty","Test prázdného seznamu"],["lists_indexOf","Index objektu v listu"]]));const T=O.javascriptGenerator;class S{constructor(e){c(this,"_workspace");c(this,"_eventBehaviour");c(this,"_workspaceGenerator");c(this,"destination");this.destination=e,this._eventBehaviour=new f,this._workspaceGenerator=new x(e),this._setupBlockly([])}getWorkspace(){const e=v.serialization.workspaces.save(this._workspace);return JSON.stringify(e)}loadWorkspace(e,t){try{let s=JSON.parse(e);return v.serialization.workspaces.load(s,this._workspace),t.loadRuleChecks||this._workspace.getBlocksByType("rule_check").forEach(a=>{a.dispose(!0)}),!0}catch{return!1}}_setupBlockly(e){this._workspace=this._workspaceGenerator.createWorkspace(e),this._workspace.addChangeListener(t=>{(t.type=="move"||t.type=="change")&&this._emit("code-change",this.getWorkspace())})}getBlocks(){let e=[];return this._workspace.getToolbox().getToolboxItems().forEach(t=>{const s=t.getContents();s.constructor===Array?s.forEach(a=>{e.push({category:t.getName(),name:y.getName(a.type),type:a.type})}):(s=="VARIABLE"&&e.push({category:"Proměnné",name:"Bloky pro práci s proměnnými",type:"variables"}),s=="PROCEDURE"&&e.push({category:"Funkce",name:"Bloky pro práci s funkcemi",type:"functions"}))}),e}_emit(e,t){this._eventBehaviour.emit(e,t)}on(e,t){this._eventBehaviour.on(e,t)}clearWorkspace(){this.loadWorkspace("{}",{loadRuleChecks:!0})}getCode(){return T.workspaceToCode(this._workspace)}setupToolbox(e){e.length!=0&&this._workspace.getToolbox().getToolboxItems().forEach(t=>{var s;if(!e.some(a=>a.category==t.getName()))t.hide();else{let a=[];typeof t.getContents()!="string"&&((s=t.getContents())==null||s.forEach(o=>{e.some(n=>n.type==o.type)&&a.push(o)}),t==null||t.updateFlyoutContents(a))}})}}class g{static initCostumeData(e){this.costumeData=e}static goForward(e){return{objectId:e,name:"goforward"}}static jump(e){return{objectId:e,name:"jump"}}static turn(e,t){return{objectId:e,name:"turn",side:t}}static setDirection(e,t){return{objectId:e,name:"setdirection",direction:t}}static jumpTo(e,t,s){return{objectId:e,name:"jumpto",x:t,y:s}}static say(e,t){return{objectId:e,name:"say",message:t}}static changeCostume(e,t){return{objectId:e,name:"changecostume",costumeName:t}}static changeBackground(e,t){return{objectId:e,name:"changebackground",backgroundName:t}}static show(e){return{objectId:e,name:"show"}}static hide(e){return{objectId:e,name:"hide"}}static setLayer(e,t){return{objectId:e,name:"setlayer",layer:t}}static sendMessage(e,t){return{objectId:e,name:"sendmessage",message:t}}static wait(e,t){return{objectId:e,name:"wait",roundAmount:t}}static win(e,t){return{objectId:e,name:"win",message:t}}static gameOver(e,t){return{objectId:e,name:"gameover",message:t}}static performOnPuzzle(e,t){switch(e.name){case"changebackground":e.backgroundName;break;case"changecostume":const s=e.costumeName,a=this.costumeData.find(h=>h.name==s);a&&t.changeObjectCostume(e.objectId,a);break;case"gameover":break;case"goforward":t.commands.goForward(e.objectId);break;case"hide":t.commands.hide(e.objectId);break;case"jump":t.commands.jump(e.objectId);break;case"jumpto":const o=e.x,n=e.y;t.commands.jumpTo(e.objectId,o,n);break;case"say":break;case"sendmessage":break;case"setdirection":const i=e.direction;t.commands.setDirection(e.objectId,i);break;case"setlayer":const r=e.layer;t.commands.setLayer(e.objectId,r);break;case"show":t.commands.show(e.objectId);break;case"turn":const l=e.side;t.commands.turn(e.objectId,l);break}}static instant(e){return e.filter(t=>this.instantInstructions.includes(t.name))}static takeTime(e){return e.filter(t=>!this.instantInstructions.includes(t.name))}static byObject(e){return[...new Set(e.map(s=>s.objectId))].map(s=>({id:s,instructions:e.filter(a=>a.objectId===s)}))}static async withNotification(e,t){for(const s of e)if(s.name=="say"){const a=s.message;await t.notify(a)}else if(s.name==="win"){const a=s.message;await t.notify(a)}else if(s.name==="gameover"){const a=s.message;await t.notify(a)}}}c(g,"costumeData"),c(g,"instantInstructions",["changebackground","changecostume","jumpto","setdirection","setlayer","show","hide"]);class L{constructor(e,t){c(this,"_eventBehaviour");c(this,"_konvaContainer");c(this,"_konvaData");c(this,"_selectedObject");c(this,"_loadedCostumes");c(this,"_destination");c(this,"_options");c(this,"maxAnimationTime");c(this,"animationTime");this._eventBehaviour=new f,this._destination=e,this._options=t,this.maxAnimationTime=1.5,this.animationTime=.75,this._loadedCostumes=[],this._konvaContainer=document.getElementById(e),this._konvaData=this._initKonva(this._konvaContainer.offsetWidth,this._konvaContainer.offsetHeight,5),this._selectedObject="",this._drawBackground()}on(e,t){this._eventBehaviour.on(e,t)}_emit(e,t){this._eventBehaviour.emit(e,t)}setSelected(e){this._selectedObject=e}_initKonva(e,t,s){let a=e,o=t,n=s,i=a-o<0?a:o,r=i/(s*8),l=r*n,h=(i-l)/n,u=h*n+l-r,p=(a-u)/2,k=(o-u)/2,w=p+h/2,b=k+h/2,_={stage:new d.Stage({container:this._destination,width:a,height:o}),backgroundLayer:new d.Layer,objectLayer:new d.Layer,width:a,height:o,innerBoardWidth:u,shorterSide:i,spaceWidth:r,squareWidth:h,leftOffset:p,topOffset:k,boardSideSize:n,startX:w,startY:b,objects:[]};return _.stage.add(_.backgroundLayer),_.stage.add(_.objectLayer),_}_drawBackground(){let e=this._konvaData.spaceWidth,t=this._konvaData.squareWidth,s=this._konvaData.leftOffset,a=this._konvaData.topOffset,o=this._konvaData.boardSideSize;for(let i=0;i<o;i++)for(let r=0;r<o;r++){var n=new d.Rect({x:i*(t+e)+s,y:r*(t+e)+a,width:t,height:t,fill:"#FFFFFF66",cornerRadius:25,stroke:void 0});this._konvaData.backgroundLayer.add(n)}}async render(e,t){e.sideWidth!=this._konvaData.boardSideSize&&(this._konvaData=this._initKonva(this._konvaData.width,this._konvaData.height,e.sideWidth),this._drawBackground()),this._clearLayer(),await t.sort((a,o)=>a.settings.layer-o.settings.layer).forEach(async a=>{const o=await this._createInstance(a);this._addObjectToLayer(o,a),this._setDragBehaviour(o,a)})}async animate(e,t,s,a){return await this.render(e,t),new Promise((o,n)=>{const i=async r=>{if(s.length<=r){o(null);return}const l=s[r];g.performOnPuzzle(l,a);const h=this._prepareAnimation(l,async()=>{i(r+1)});h?h.play():i(r+1)};i(0)})}_prepareAnimation(e,t){const s=this._konvaData.objects.find(a=>a.puzzleObject.id==e.objectId);if(!s)return null;if(e.name=="goforward")return this._createMoveAnimation(s,t,1);if(e.name=="jump")return this._createMoveAnimation(s,t,2);if(e.name=="turn"){const a=e.side,o=s.konvaObject.rotation(),n=a=="left"?-1:1;return new d.Tween({node:s.konvaObject,duration:this.animationTime,easing:d.Easings.EaseInOut,rotation:o+90*n,onFinish:t})}else if(e.name=="setdirection"){const a=e.direction;return new d.Tween({node:s.konvaObject,duration:0,easing:d.Easings.EaseInOut,rotation:this.directionToAngle(a),onFinish:t})}else if(e.name=="jumpto"){const a=e,o=this.positionToCoordinates(a.x,a.y);return new d.Tween({node:s.konvaObject,duration:0,x:o.x,y:o.y,easing:d.Easings.EaseInOut,onFinish:t})}else return e.name=="show"?new d.Tween({node:s.konvaObject,duration:0,visible:!0,easing:d.Easings.EaseInOut,onFinish:t}):e.name=="hide"?new d.Tween({node:s.konvaObject,duration:0,visible:!1,easing:d.Easings.EaseInOut,onFinish:t}):e.name=="wait"?(e.roundAmount,{play:()=>{setTimeout(()=>{t()},this.animationTime*1e3)}}):null}_createMoveAnimation(e,t,s){const a=e.puzzleObject.settings.direction,o=a=="up"||a=="down"?1:0,n=1-o,i=e.konvaObject.x(),r=e.konvaObject.y(),l=a=="left"||a=="up"?-1:1,h=(this._konvaData.squareWidth+this._konvaData.spaceWidth)*s;return new d.Tween({node:e.konvaObject,duration:this.animationTime,easing:d.Easings.EaseInOut,x:i+h*n*l,y:r+h*o*l,onFinish:t})}_clearLayer(){this._konvaData.objectLayer.removeChildren(),this._konvaData.objects=[]}_addObjectToLayer(e,t){this._konvaData.objects.some(a=>a.puzzleObject.id==t.id)||(this._konvaData.objectLayer.add(this._setImage(e,t)),this._konvaData.objects=[...this._konvaData.objects,{puzzleObject:t,konvaObject:e}])}positionToCoordinates(e,t){const s=this._konvaData.startX,a=this._konvaData.startY,o=this._konvaData.squareWidth,n=this._konvaData.spaceWidth;return{x:s+e*(o+n),y:a+t*(o+n)}}_setImage(e,t){const s=this._konvaData.startX,a=this._konvaData.startY,o=this._konvaData.squareWidth,n=this._konvaData.spaceWidth;return e.setAttrs({x:s+t.settings.X*(o+n),y:a+t.settings.Y*(o+n),width:o,height:o,offset:{x:o/2,y:o/2},draggable:this._options.draggable,rotation:this._getAngle(t),shadowColor:"blue",shadowBlur:10,shadowOffset:{x:0,y:0},shadowOpacity:t.id==this._selectedObject?1:0,visible:t.settings.visible}),e}_getAngle(e){let t=0;return e.settings.direction=="up"?t=180:e.settings.direction=="right"?t=-90:e.settings.direction=="down"?t=0:t=90,t}directionToAngle(e){let t=0;return e=="up"?t=180:e=="right"?t=-90:e=="down"?t=0:t=90,t}_createInstance(e){const t=e.settings.costume.path;return new Promise((s,a)=>{var o;if(!this._loadedCostumes.some(n=>n.path==t))d.Image.fromURL(t,n=>{const i={path:t,image:n};this._loadedCostumes.push(i),s(i.image)});else{let n=(o=this._loadedCostumes.find(i=>i.path==t))==null?void 0:o.image;s(n.clone())}})}_setDragBehaviour(e,t){e.on("mouseup touchend dragend",()=>{const s=this._konvaData.startX,a=this._konvaData.startY,o=this._konvaData.squareWidth,n=this._konvaData.spaceWidth,i=Math.round((e.x()-s)/(o+n)),r=Math.round((e.y()-a)/(o+n));this._options.draggable&&this._emit("object-moved",{objectId:t.id,x:i,y:r}),this._options.selectable=="player"&&t.settings.playerEdit&&this._emit("object-selected",{x:i,y:r,objectId:t.id})})}getPreviewImage(){return this._konvaData.stage.toDataURL({pixelRatio:.3})}changeAnimationSpeed(e){this.animationTime=this.maxAnimationTime*e}}export{S as B,f as E,g as I,L as K};
